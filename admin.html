<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Makkos Liga â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 12px;
    }
    input, select, button {
      margin: 4px 0;
      padding: 6px 8px;
    }
    hr { margin: 20px 0; }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 0;
    }
    .row span { flex: 1; }
    .small { font-size: 0.9em; color: #444; }
    .card {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
    }
    .danger { background: #ffecec; }
  </style>
</head>
<body>

<h1>âš½ Makkos Liga â€“ Admin</h1>

<p id="status">EllenÅ‘rzÃ©sâ€¦</p>

<hr>

<h3>ğŸ Szezon</h3>
<button onclick="endSeason()">ğŸ Szezon vÃ©ge</button>
<p id="seasonMsg"></p>

<hr>

<h3>JÃ¡tÃ©kos hozzÃ¡adÃ¡sa</h3>
<input type="text" id="playerName" placeholder="JÃ¡tÃ©kos neve">
<button onclick="addPlayer()">HozzÃ¡adÃ¡s</button>
<p id="addMsg"></p>

<hr>

<h3>Meccs rÃ¶gzÃ­tÃ©se (âš« Fekete vs âšª FehÃ©r)</h3>

<div id="teamSelector"></div>

<div class="row">
  <span>âš« Fekete gÃ³l:</span>
  <input type="number" id="blackScore" min="0" value="0">
</div>

<div class="row">
  <span>âšª FehÃ©r gÃ³l:</span>
  <input type="number" id="whiteScore" min="0" value="0">
</div>

<button onclick="saveMatch()">ğŸ’¾ Meccs mentÃ©se</button>
<p id="matchMsg"></p>

<hr>

<h3>UtolsÃ³ meccsek</h3>
<div id="matchesList"></div>

<hr>

<button onclick="logout()">KijelentkezÃ©s</button>

<script>
  const supabaseUrl = "https://kqtzyhmksnjowielrwii.supabase.co";
  const supabaseKey = "sb_publishable_vgSmqItheOG3aeOdoNionA_rd-4MTL2";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  async function checkLogin() {
    const { data } = await supabaseClient.auth.getSession();
    if (!data.session) window.location.href = "login.html";
    document.getElementById("status").innerText = "âœ… Bejelentkezve (admin)";
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  async function addPlayer() {
    const name = document.getElementById("playerName").value.trim();
    if (!name) return;

    const { error } = await supabaseClient.from("tabella").insert([{ name }]);
    if (error) {
      alert(error.message);
      return;
    }

    document.getElementById("playerName").value = "";
    loadPlayersForMatch();
  }

  async function loadPlayersForMatch() {
    const { data } = await supabaseClient
      .from("tabella")
      .select("id, name")
      .order("name");

    const container = document.getElementById("teamSelector");
    container.innerHTML = "";

    data.forEach(p => {
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <span>${p.name}</span>
        <select data-player-id="${p.id}">
          <option value="">â€“</option>
          <option value="black">âš« Fekete</option>
          <option value="white">âšª FehÃ©r</option>
        </select>
      `;
      container.appendChild(row);
    });
  }

  async function saveMatch() {
    const blackScore = Number(document.getElementById("blackScore").value);
    const whiteScore = Number(document.getElementById("whiteScore").value);

    const blackPlayers = [];
    const whitePlayers = [];

    document.querySelectorAll("#teamSelector select").forEach(sel => {
      if (sel.value === "black") blackPlayers.push(sel.dataset.playerId);
      if (sel.value === "white") whitePlayers.push(sel.dataset.playerId);
    });

    if (!blackPlayers.length || !whitePlayers.length) {
      document.getElementById("matchMsg").innerText = "âŒ MindkÃ©t csapat kÃ¶telezÅ‘";
      return;
    }

    const { error } = await supabaseClient.rpc("apply_match_result", {
      black_players: blackPlayers,
      white_players: whitePlayers,
      black_goals: blackScore,
      white_goals: whiteScore
    });

    if (error) {
      console.error(error);
      document.getElementById("matchMsg").innerText = "âŒ Hiba mentÃ©skor";
      return;
    }

    document.getElementById("matchMsg").innerText = "âœ… Meccs mentve";
    loadMatches();
  }

  async function deleteMatch(matchId) {
    if (!confirm("Biztos tÃ¶rlÃ¶d ezt a meccset?")) return;

    const { error } = await supabaseClient.rpc(
      "delete_match_and_rollback",
      { match_to_delete: matchId }
    );

    if (error) {
      alert(error.message);
      return;
    }

    const card = document.querySelector(`.card[data-match-id="${matchId}"]`);
    if (card) card.remove();
  }

  async function loadMatches() {
    const { data: matches } = await supabaseClient
      .from("matches")
      .select("id, round, black_score, white_score, created_at")
      .order("created_at", { ascending: false });

    const { data: mp } = await supabaseClient
      .from("match_players")
      .select("match_id, team, tabella(name)");

    const list = document.getElementById("matchesList");
    list.innerHTML = "";

    matches.forEach(m => {
      const black = mp.filter(x => x.match_id === m.id && x.team === "black").map(x => x.tabella?.name);
      const white = mp.filter(x => x.match_id === m.id && x.team === "white").map(x => x.tabella?.name);

      const card = document.createElement("div");
      card.className = "card danger";
      card.dataset.matchId = m.id;
      card.innerHTML = `
        <div><b>${m.round}. fordulÃ³</b> â€“ <span class="small">${new Date(m.created_at).toLocaleString("hu-HU")}</span></div>
        <div><b>EredmÃ©ny:</b> âš« ${m.black_score} â€“ ${m.white_score} âšª</div>
        <div><b>âš« Fekete:</b> ${black.join(", ")}</div>
        <div><b>âšª FehÃ©r:</b> ${white.join(", ")}</div>
        <button onclick="deleteMatch('${m.id}')">ğŸ—‘ï¸ Meccs tÃ¶rlÃ©se</button>
      `;
      list.appendChild(card);
    });
  }

  async function endSeason() {
    if (!confirm("Biztos lezÃ¡rod a szezont Ã©s Ãºj Ã©vet indÃ­tasz?")) return;

    const { data, error } = await supabaseClient.rpc("end_season");

    if (error) {
      alert(error.message);
      return;
    }

    document.getElementById("seasonMsg").innerText =
      `âœ… Ãšj szezon elindÃ­tva: ${data}`;
  }

  checkLogin();
  loadPlayersForMatch();
  loadMatches();
</script>

</body>
</html>
