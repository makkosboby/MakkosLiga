<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Liga Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#111114;
      --panel2:#15151a;
      --text:#ffffff;
      --muted:#b3b3b3;
      --line: rgba(255,255,255,0.08);
      --line2: rgba(255,255,255,0.14);
      --red:#c4161c;
      --red-soft: rgba(196,22,28,.15);
      --shadow: 0 14px 40px rgba(0,0,0,.65);
      --radius:14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
    }

    /* ===== TOP BAR (sticky) ===== */
    .admin-topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(180deg, #ffffff, #f4f4f4);
      color:#111;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .admin-topbar::after{
      content:"";
      display:block;
      height:4px;
      background: var(--red);
    }
    .topbar-inner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .brand img{ height:34px; object-fit:contain; }
    .brand-title{
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 16px;
      white-space: nowrap;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .top-link{
      text-decoration:none;
      color:#111;
      font-weight:700;
      font-size:13px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      cursor:pointer;
    }
    .top-link:hover{ border-color: rgba(0,0,0,.22); }
    .danger-link{
      border-color: rgba(196,22,28,.45);
      background: rgba(196,22,28,.08);
    }
    .danger-link:hover{ background: rgba(196,22,28,.14); }

    /* ===== MAIN LAYOUT ===== */
    .wrap{
      max-width: 1180px;
      margin: 16px auto 28px;
      padding: 0 14px;
    }

    .status-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 10px 0 14px;
      flex-wrap: wrap;
    }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: var(--red-soft);
      border: 1px solid rgba(196,22,28,.35);
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap: 14px;
      align-items: start;
    }
    @media(max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card-title{
      font-size: 13px;
      font-weight: 900;
      letter-spacing:.35px;
      text-transform: uppercase;
      color: #fff;
    }
    .card-body{ padding: 12px 14px; }

    .muted{ color: var(--muted); font-size: 12px; }
    .sep{ height:1px; background: var(--line); margin: 12px 0; }

    /* ===== FORMS ===== */
    label{ font-size: 12px; color: var(--muted); }
    input, select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background:#000;
      color:#fff;
      outline: none;
    }
    input:focus, select:focus{ border-color: rgba(196,22,28,.8); }

    .row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .row > *{ flex:1; }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: #000;
      color:#fff;
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.15px;
    }
    .btn:hover{
      border-color: rgba(196,22,28,.7);
      background: rgba(196,22,28,.12);
    }
    .btn-primary{
      border-color: rgba(196,22,28,.85);
      background: linear-gradient(180deg, rgba(196,22,28,.35), rgba(196,22,28,.14));
    }
    .btn-primary:hover{ background: rgba(196,22,28,.28); }
    .btn-danger{
      border-color: rgba(196,22,28,.75);
      background: rgba(196,22,28,.10);
    }
    .btn-danger:hover{ background: rgba(196,22,28,.18); }
    .btn-ghost{
      background: transparent;
    }
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btns .btn{ width:auto; }

    /* ===== TEAM SELECTOR ===== */
    .selector{
      max-height: 420px;
      overflow:auto;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(0,0,0,.35);
    }
    .player-row{
      display:grid;
      grid-template-columns: 1fr 160px;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .player-row:last-child{ border-bottom: none; }
    .player-name{
      font-weight: 700;
      font-size: 13px;
    }
    .player-row select{ width: 100%; }

    /* ===== MATCH LIST ===== */
    .match-card{
      border: 1px solid var(--line);
      background: #000;
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
    }
    .match-top{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 6px;
    }
    .small{ font-size: 12px; color: var(--muted); }
    .score{
      font-weight: 900;
      letter-spacing: .3px;
    }
    .teams{ font-size: 13px; margin-top: 6px; }
    .teams span{ color: var(--muted); }

    .danger-zone{
      border: 1px solid rgba(196,22,28,.35);
      background: rgba(196,22,28,.06);
      border-radius: 12px;
      padding: 12px;
    }

    /* mobile tweaks */
    @media(max-width: 520px){
      .player-row{ grid-template-columns: 1fr 140px; }
      .top-link{ padding:8px 9px; }
    }
  </style>
</head>

<body>

  <!-- Sticky top bar -->
  <div class="admin-topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="assets/logo4.png" alt="Makkos Liga">
        <div class="brand-title">Makkos Liga ‚Äì Admin</div>
      </div>

      <div class="top-actions">
        <a class="top-link" href="index.html">Tabella</a>
        <button class="top-link danger-link" onclick="logout()" type="button">Kijelentkez√©s</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="status-row">
      <div id="status" class="pill">Ellen≈ërz√©s‚Ä¶</div>
      <div class="muted">Tipp: j√°t√©kosok kiv√°laszt√°sa ut√°n csak √≠rd be a g√≥lokat √©s ment√©s.</div>
    </div>

    <div class="grid">

      <!-- LEFT: match input + recent matches -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Meccs r√∂gz√≠t√©se</div>
          <span class="pill">‚ö´ Fekete vs ‚ö™ Feh√©r</span>
        </div>

        <div class="card-body">

          <div class="muted" style="margin-bottom:8px;">V√°laszd ki, ki melyik csapatban j√°tszott.</div>

          <div class="selector" id="teamSelector"></div>

          <div class="sep"></div>

          <div class="row" style="gap:12px;">
            <div>
              <label>‚ö´ Fekete g√≥l</label>
              <input type="number" id="blackScore" min="0" value="0">
            </div>
            <div>
              <label>‚ö™ Feh√©r g√≥l</label>
              <input type="number" id="whiteScore" min="0" value="0">
            </div>
          </div>

          <div class="btns" style="margin-top:12px;">
            <button class="btn btn-primary" onclick="saveMatch()" type="button">üíæ Meccs ment√©se</button>
            <button class="btn btn-ghost" onclick="clearTeamSelection()" type="button">üßπ Kijel√∂l√©sek t√∂rl√©se</button>
            <button class="btn btn-ghost" onclick="clearTeam('black')" type="button">‚ö´ Fekete √ºr√≠t</button>
            <button class="btn btn-ghost" onclick="clearTeam('white')" type="button">‚ö™ Feh√©r √ºr√≠t</button>
          </div>

          <div id="matchMsg" class="muted" style="margin-top:10px;"></div>

          <div class="sep"></div>

          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div class="card-title" style="text-transform:none; font-size:12px; letter-spacing:.2px;">Utols√≥ meccsek</div>
            <button class="btn btn-ghost" onclick="loadMatches()" type="button">‚Üª Friss√≠t√©s</button>
          </div>

          <div id="matchesList"></div>

        </div>
      </div>

      <!-- RIGHT: season + add player -->
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Szezon kezel√©se</div>
            <span class="pill">Vesz√©lyz√≥na</span>
          </div>
          <div class="card-body">
            <div class="danger-zone">
              <div class="muted" style="margin-bottom:10px;">
                A ‚ÄúSzezon v√©ge‚Äù √∫j √©vet ind√≠t √©s az aktu√°lis szezon statjait null√°zza (a nevek maradnak).
              </div>
              <button class="btn btn-danger" onclick="endSeason()" type="button">üèÅ Szezon v√©ge</button>
              <div id="seasonMsg" class="muted" style="margin-top:10px;"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="card-header">
            <div class="card-title">J√°t√©kos hozz√°ad√°sa</div>
            <span class="pill">Tabella</span>
          </div>
          <div class="card-body">
            <label>J√°t√©kos neve</label>
            <input type="text" id="playerName" placeholder="Pl.: Kov√°cs Dani">
            <div class="btns" style="margin-top:12px;">
              <button class="btn btn-primary" onclick="addPlayer()" type="button">‚ûï Hozz√°ad√°s</button>
            </div>
            <div id="addMsg" class="muted" style="margin-top:10px;"></div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="card-header">
            <div class="card-title">Gyors tippek</div>
            <span class="pill">UX</span>
          </div>
          <div class="card-body">
            <div class="muted">
              ‚Ä¢ Ha sok j√°t√©kos van: g√∂rgess a list√°ban, a kiv√°laszt√°sok megmaradnak.<br>
              ‚Ä¢ Ment√©s ut√°n a meccsek list√°ja automatikusan friss√ºl.<br>
              ‚Ä¢ T√∂rl√©s visszag√∂rgeti a statokat (rollback).
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
  const supabaseUrl = "https://kqtzyhmksnjowielrwii.supabase.co";
  const supabaseKey = "sb_publishable_vgSmqItheOG3aeOdoNionA_rd-4MTL2";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  async function checkLogin() {
    const { data } = await supabaseClient.auth.getSession();
    if (!data.session) window.location.href = "login.html";
    document.getElementById("status").innerText = "‚úÖ Bejelentkezve (admin)";
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    window.location.href = "login.html";
  }

  async function addPlayer() {
    const name = document.getElementById("playerName").value.trim();
    if (!name) return;

    const { error } = await supabaseClient.from("tabella").insert([{ name }]);
    if (error) {
      document.getElementById("addMsg").innerText = "‚ùå " + error.message;
      return;
    }

    document.getElementById("addMsg").innerText = "‚úÖ J√°t√©kos hozz√°adva";
    document.getElementById("playerName").value = "";
    loadPlayersForMatch();
  }

  async function loadPlayersForMatch() {
    const { data, error } = await supabaseClient
      .from("tabella")
      .select("id, name")
      .order("name");

    if (error) { console.error(error); return; }

    const container = document.getElementById("teamSelector");
    container.innerHTML = "";

    (data || []).forEach(p => {
      const row = document.createElement("div");
      row.className = "player-row";
      row.innerHTML = `
        <div class="player-name">${p.name}</div>
        <select data-player-id="${p.id}">
          <option value="">‚Äì</option>
          <option value="black">‚ö´ Fekete</option>
          <option value="white">‚ö™ Feh√©r</option>
        </select>
      `;
      container.appendChild(row);
    });
  }

  function clearTeamSelection(){
    document.querySelectorAll("#teamSelector select").forEach(sel => sel.value = "");
    document.getElementById("matchMsg").innerText = "Kijel√∂l√©sek t√∂r√∂lve.";
  }

  function clearTeam(team){
    document.querySelectorAll("#teamSelector select").forEach(sel => {
      if (sel.value === team) sel.value = "";
    });
    document.getElementById("matchMsg").innerText = team === "black" ? "‚ö´ Fekete csapat √ºr√≠tve." : "‚ö™ Feh√©r csapat √ºr√≠tve.";
  }

  async function saveMatch() {
    const blackScore = Number(document.getElementById("blackScore").value);
    const whiteScore = Number(document.getElementById("whiteScore").value);

    const blackPlayers = [];
    const whitePlayers = [];

    document.querySelectorAll("#teamSelector select").forEach(sel => {
      if (sel.value === "black") blackPlayers.push(sel.dataset.playerId);
      if (sel.value === "white") whitePlayers.push(sel.dataset.playerId);
    });

    if (!blackPlayers.length || !whitePlayers.length) {
      document.getElementById("matchMsg").innerText = "‚ùå Mindk√©t csapat k√∂telez≈ë";
      return;
    }

    const { error } = await supabaseClient.rpc("apply_match_result", {
      black_players: blackPlayers,
      white_players: whitePlayers,
      black_goals: blackScore,
      white_goals: whiteScore
    });

    if (error) {
      console.error(error);
      document.getElementById("matchMsg").innerText = "‚ùå Hiba ment√©skor";
      return;
    }

    document.getElementById("matchMsg").innerText = "‚úÖ Meccs mentve";
    loadMatches();
  }

  async function deleteMatch(matchId) {
    if (!confirm("Biztos t√∂rl√∂d ezt a meccset? (stat rollback)")) return;

    const { error } = await supabaseClient.rpc(
      "delete_match_and_rollback",
      { match_to_delete: matchId }
    );

    if (error) {
      alert(error.message);
      return;
    }

    const card = document.querySelector(`.match-card[data-match-id="${matchId}"]`);
    if (card) card.remove();
  }

  async function loadMatches() {
    const { data: matches, error: mErr } = await supabaseClient
      .from("matches")
      .select("id, round, black_score, white_score, created_at")
      .order("created_at", { ascending: false })
      .limit(20);

    if (mErr) { console.error(mErr); return; }

    const { data: mp, error: mpErr } = await supabaseClient
      .from("match_players")
      .select("match_id, team, tabella(name)");

    if (mpErr) { console.error(mpErr); return; }

    const list = document.getElementById("matchesList");
    list.innerHTML = "";

    (matches || []).forEach(m => {
      const black = (mp || []).filter(x => x.match_id === m.id && x.team === "black").map(x => x.tabella?.name);
      const white = (mp || []).filter(x => x.match_id === m.id && x.team === "white").map(x => x.tabella?.name);

      const card = document.createElement("div");
      card.className = "match-card";
      card.dataset.matchId = m.id;
      card.innerHTML = `
        <div class="match-top">
          <div><b>${m.round}. fordul√≥</b> <span class="small">‚Äì ${new Date(m.created_at).toLocaleString("hu-HU")}</span></div>
          <div class="score">‚ö´ ${m.black_score} ‚Äì ${m.white_score} ‚ö™</div>
        </div>
        <div class="teams"><span>‚ö´</span> ${black.join(", ") || "‚Äî"}</div>
        <div class="teams"><span>‚ö™</span> ${white.join(", ") || "‚Äî"}</div>
        <div style="margin-top:10px;">
          <button class="btn btn-danger" onclick="deleteMatch('${m.id}')" type="button">üóëÔ∏è Meccs t√∂rl√©se</button>
        </div>
      `;
      list.appendChild(card);
    });
  }

  async function endSeason() {
    if (!confirm("Biztos lez√°rod a szezont √©s √∫j √©vet ind√≠tasz?")) return;

    const { data, error } = await supabaseClient.rpc("end_season");

    if (error) {
      alert(error.message);
      return;
    }

    document.getElementById("seasonMsg").innerText =
      `‚úÖ √öj szezon elind√≠tva: ${data}`;
  }

  checkLogin();
  loadPlayersForMatch();
  loadMatches();
</script>

</body>
</html>

