<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" type="image/x-icon" href="/MakkosLiga/favicon.ico">
  <title>Makkos Liga</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>

  <!-- FEH√âR HEADER -->
  <header class="site-header">
    <div class="header-inner">

      <!-- BAL: LOG√ì + KUPA -->
      <div class="header-left">
        <img src="assets/logo4.png" alt="Makkos Liga logo" class="logo-main">
        <img src="assets/kupa.png" alt="Kupa" class="logo-cup">
      </div>

      <!-- JOBB: ADMIN -->
      <div class="header-right">
        <a class="admin-link" href="admin.html">Admin</a>
      </div>

    </div>
  </header>

  <div class="accent-bar"></div>

  <div class="container">
    <div class="layout">

      <!-- TABLA -->
      <div class="card">
        <div class="card-header tabella-header">
          <div class="card-title">Tabella</div>

          <div class="tabella-header-right">
            <select id="seasonSelect"></select>
          </div>
        </div>

        <div class="card-body table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th style="text-align:left">N√©v</th>
                <th>M</th><th>Gy</th><th>D</th><th>V</th>
                <th>LG</th><th>KG</th><th>GK</th><th>P</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
            <!-- ‚úÖ √úZEN≈êFAL / H√çREK: meccsek k√°rtya alatt -->
        <div id="newsWall" class="news-wall" "></div>
        <div class="card" id="playerCard">
          <div class="card-header">
            <div class="card-title">J√°t√©kos</div>
            <span class="pill">√ñsszes√≠tett</span>
          </div>
          <div class="card-body">
            <div class="muted">Kattints egy n√©vre a tabell√°ban.</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="card-header">
            <div class="card-title">Meccsek</div>
            <span id="matchesMeta" class="pill">‚Äî</span>
          </div>
          <div class="card-body">
            <div class="roundbar">
              <select id="roundSelect"></select>
              <button class="btn" id="prevRoundBtn" type="button">‚óÄ</button>
              <button class="btn" id="nextRoundBtn" type="button">‚ñ∂</button>
            </div>

            <div id="matchesList" style="margin-top:10px;"></div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- FOOTER: T√úKR√ñZVE -->
  <div class="footer-accent-bar"></div>
  <footer class="site-footer">
    <div class="footer-inner">

      <div class="footer-left">
        <div class="footer-title">Egy√ºttm≈±k√∂d≈ë partnereink:</div>
        <div class="footer-partners">
          <img src="assets/szatmari.png" alt="Szatmari" class="partner-logo">
          <img src="assets/bernath.png" alt="Bernath" class="partner-logo">
          <img src="assets/imiteto.png" alt="Imiteto" class="partner-logo">
        </div>
      </div>

      <div class="footer-right">
        <img src="assets/jatekosok.png" alt="J√°t√©kosok" class="footer-players">
      </div>

    </div>
  </footer>

<script>
/* ==== SUPABASE CLIENT ==== */
const supabaseUrl = "https://kqtzyhmksnjowielrwii.supabase.co";
const supabaseKey = "sb_publishable_vgSmqItheOG3aeOdoNionA_rd-4MTL2";
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ==== DOM ==== */
const seasonSelect = document.getElementById("seasonSelect");
const tbody = document.getElementById("tbody");
const playerCard = document.getElementById("playerCard");

const roundSelect = document.getElementById("roundSelect");
const prevRoundBtn = document.getElementById("prevRoundBtn");
const nextRoundBtn = document.getElementById("nextRoundBtn");
const matchesMeta = document.getElementById("matchesMeta");
const matchesList = document.getElementById("matchesList");

const newsWall = document.getElementById("newsWall");

/* ==== STATE ==== */
let seasons = [];
let selectedSeasonId = null;
let selectedSeasonYear = null;

let selectedPlayerId = null;

let allSeasonMatches = [];
let allSeasonMP = [];
let availableRounds = [];
let selectedRound = null;

/* ==== REALTIME (debounced reload) ==== */
let chSeasons = null;
let chSeasonStats = null;
let chMatches = null;
let chMatchPlayers = null;
let chAnnouncements = null;

let tableTimer = null;
let matchesTimer = null;
let playerTimer = null;

function scheduleTable(fn, delay = 200) {
  if (tableTimer) clearTimeout(tableTimer);
  tableTimer = setTimeout(fn, delay);
}

function scheduleMatches(fn, delay = 250) {
  if (matchesTimer) clearTimeout(matchesTimer);
  matchesTimer = setTimeout(fn, delay);
}

function schedulePlayer(fn, delay = 350) {
  if (playerTimer) clearTimeout(playerTimer);
  playerTimer = setTimeout(fn, delay);
}

function stopRealtime() {
  if (chSeasons) supabaseClient.removeChannel(chSeasons);
  if (chSeasonStats) supabaseClient.removeChannel(chSeasonStats);
  if (chMatches) supabaseClient.removeChannel(chMatches);
  if (chMatchPlayers) supabaseClient.removeChannel(chMatchPlayers);
  if (chAnnouncements) supabaseClient.removeChannel(chAnnouncements);
  chSeasons = chSeasonStats = chMatches = chMatchPlayers = chAnnouncements = null;
}

function startRealtime() {
  stopRealtime();

  // 1) Szezon v√°ltoz√°s: admin "Szezon v√©ge" -> √∫j aktu√°lis szezon -> automatikus v√°lt√°s
  chSeasons = supabaseClient
    .channel("public:seasons-live")
    .on("postgres_changes", { event: "*", schema: "public", table: "seasons" }, async () => {
      const prevSeasonId = selectedSeasonId;

      await loadSeasons();     // ez mindig az aktu√°lisra √°ll√≠t
      await loadTable();
      await loadMatches();
      if (selectedPlayerId) await loadPlayerCard(selectedPlayerId);

      // ha szezon v√°ltott, a realtime-t √∫jraind√≠tjuk (biztos sz≈±r√©s)
      if (prevSeasonId !== selectedSeasonId) {
        setTimeout(() => startRealtime(), 150);
      }
    })
    .subscribe();

  // 2) Tabella realtime
  chSeasonStats = supabaseClient
    .channel("public:season-stats-live")
    .on("postgres_changes", { event: "*", schema: "public", table: "season_stats" }, (payload) => {
      const sid = payload?.new?.season_id || payload?.old?.season_id;
      if (sid && sid === selectedSeasonId) {
        scheduleTable(() => loadTable(), 200);
        if (selectedPlayerId) schedulePlayer(() => loadPlayerCard(selectedPlayerId), 350);
      }
    })
    .subscribe();

  // 3) Meccsek realtime
  chMatches = supabaseClient
    .channel("public:matches-live")
    .on("postgres_changes", { event: "*", schema: "public", table: "matches" }, (payload) => {
      const sid = payload?.new?.season_id || payload?.old?.season_id;
      if (sid && sid === selectedSeasonId) {
        scheduleMatches(() => loadMatches(), 250);
      }
    })
    .subscribe();

  // 4) match_players realtime
  chMatchPlayers = supabaseClient
    .channel("public:match-players-live")
    .on("postgres_changes", { event: "*", schema: "public", table: "match_players" }, () => {
      scheduleMatches(() => loadMatches(), 300);
      if (selectedPlayerId) schedulePlayer(() => loadPlayerCard(selectedPlayerId), 450);
    })
    .subscribe();

  // 5) ‚úÖ √úzen≈ëfal realtime
  chAnnouncements = supabaseClient
    .channel("public:announcements-live")
    .on("postgres_changes", { event: "*", schema: "public", table: "announcements" }, () => {
      loadAnnouncementPublic();
    })
    .subscribe();
}

/* ==== √úZEN≈êFAL (PUBLIC) ==== */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function loadAnnouncementPublic(){
  if (!newsWall) return;

  const { data, error } = await supabaseClient
    .from("announcements")
    .select("id, body, is_pinned, updated_at, created_at")
    .order("is_pinned", { ascending:false })
    .order("updated_at", { ascending:false })
    .limit(1);

  if (error) {
    console.error(error);
    newsWall.innerHTML = `<div class="news-empty">‚ùå √úzen≈ëfal hiba</div>`;
    return;
  }

  const row = (data || [])[0];
  if (!row) {
    newsWall.innerHTML = `<div class="news-empty">Nincs friss h√≠r.</div>`;
    return;
  }

  const dt = new Date(row.updated_at || row.created_at);
  const when = dt.toLocaleString("hu-HU");

  newsWall.innerHTML = `
    <div class="news-title">
      <b>üì∞ √úzen≈ëfal</b>
      <span class="news-meta">${when}${row.is_pinned ? " ‚Ä¢ kiemelt" : ""}</span>
    </div>
    <div class="news-body">${escapeHtml(row.body)}</div>
  `;
}

/* ==== LOADERS ==== */
async function loadSeasons() {
  const { data, error } = await supabaseClient
    .from("seasons")
    .select("id,year,is_current")
    .order("year", { ascending: false });

  if (error) { console.error(error); return; }

  seasons = data || [];
  seasonSelect.innerHTML = "";

  seasons.forEach(s => {
    const o = document.createElement("option");
    o.value = s.id;
    o.textContent = s.year + (s.is_current ? " (aktu√°lis)" : "");
    seasonSelect.appendChild(o);
  });

  const cur = seasons.find(s => s.is_current) || seasons[0];
  if (cur) {
    selectedSeasonId = cur.id;
    selectedSeasonYear = cur.year;
    seasonSelect.value = cur.id;
  }
}

async function loadTable() {
  const { data, error } = await supabaseClient
    .from("season_stats")
    .select("player_id,matches,wins,draws,losses,goals_for,goals_against,goal_diff,points,tabella(name)")
    .eq("season_id", selectedSeasonId)
    .order("points", { ascending: false })
    .order("goal_diff", { ascending: false })
    .order("matches", { ascending: false })
    .order("goals_for", { ascending: false })
    .order("goals_against", { ascending: true });

  if (error) { console.error(error); return; }

  tbody.innerHTML = "";

  (data || []).forEach((r, i) => {
    const name = r.tabella?.name ?? "";
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td data-label="">${i + 1}</td>
      <td class="name" data-label="N√©v">
        <button class="link" data-id="${r.player_id}">${name}</button>
      </td>
      <td data-label="M">${r.matches}</td>
      <td data-label="Gy">${r.wins}</td>
      <td data-label="D">${r.draws}</td>
      <td data-label="V">${r.losses}</td>
      <td data-label="LG">${r.goals_for}</td>
      <td data-label="KG">${r.goals_against}</td>
      <td data-label="GK">${r.goal_diff}</td>
      <td data-label="P"><b>${r.points}</b></td>
    `;

    // villan√°s (opcion√°lis)
    tr.classList.add("updated");
    setTimeout(() => tr.classList.remove("updated"), 1200);

    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button.link").forEach(b => {
    b.onclick = () => loadPlayerCard(b.dataset.id);
  });
}

async function loadPlayerCard(playerId) {
  selectedPlayerId = playerId;

  const body = playerCard.querySelector(".card-body");
  body.innerHTML = `<div class="muted">Bet√∂lt√©s‚Ä¶</div>`;

  const { data: stats, error: statsErr } = await supabaseClient
    .from("player_overall_stats")
    .select(`
      player_id,
      name,
      matches_total,
      black_count,
      white_count,
      goals_for_total,
      goals_against_total,
      wins_total,
      draws_total,
      losses_total
    `)
    .eq("player_id", playerId)
    .single();

  if (statsErr) {
    console.error(statsErr);
    body.innerHTML = `<div class="error">‚ùå ${statsErr.message}</div>`;
    return;
  }

  const { data: lastRows, error: formErr } = await supabaseClient
    .from("match_players")
    .select(`
      team,
      matches ( black_score, white_score, created_at )
    `)
    .eq("player_id", playerId)
    .order("created_at", { foreignTable: "matches", ascending: false })
    .limit(5);

  if (formErr) console.error(formErr);

  const form = (lastRows || [])
    .filter(r => r.matches)
    .map(r => {
      const b = r.matches.black_score;
      const w = r.matches.white_score;

      if (b === w) return { code: "D", cls: "draw", title: "D√∂ntetlen" };

      const isWin =
        (r.team === "black" && b > w) ||
        (r.team === "white" && w > b);

      return isWin
        ? { code: "W", cls: "win", title: "Gy≈ëzelem" }
        : { code: "L", cls: "loss", title: "Veres√©g" };
    });

  const formHtml = form.length
    ? `<div class="form">${form.map(x => `<span class="form-badge ${x.cls}" title="${x.title}">${x.code}</span>`).join("")}</div>`
    : `<div class="form-empty">M√©g nincs el√©g meccs a form√°hoz.</div>`;

  body.innerHTML = `
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <div style="font-size:16px; font-weight:800; letter-spacing:.2px;">${stats.name}</div>
      <div class="pill">minden szezon</div>
    </div>

    <div class="kv">
      <div>Meccsek</div><div><b>${stats.matches_total}</b></div>
      <div>‚ö´ Fekete</div><div><b>${stats.black_count}</b></div>
      <div>‚ö™ Feh√©r</div><div><b>${stats.white_count}</b></div>

      <div>L≈ëtt g√≥l</div><div><b>${stats.goals_for_total}</b></div>
      <div>Kapott g√≥l</div><div><b>${stats.goals_against_total}</b></div>

      <div>Gy≈ëzelem</div><div><b>${stats.wins_total}</b></div>
      <div>D√∂ntetlen</div><div><b>${stats.draws_total}</b></div>
      <div>Veres√©g</div><div><b>${stats.losses_total}</b></div>
    </div>

    <div class="form-row">
      <div class="form-title">
        <b>Forma</b>
        <span class="muted">utols√≥ 5 meccs</span>
      </div>
      ${formHtml}
    </div>
  `;
}

async function loadMatches() {
  const { data: matches, error: mErr } = await supabaseClient
    .from("matches")
    .select("id,round,black_score,white_score,created_at")
    .eq("season_id", selectedSeasonId)
    .order("round", { ascending: false });

  if (mErr) { console.error(mErr); return; }

  allSeasonMatches = matches || [];
  matchesMeta.textContent = allSeasonMatches.length + " √∂sszesen";

  availableRounds = [...new Set(allSeasonMatches.map(m => m.round))].sort((a,b)=>b-a);
  roundSelect.innerHTML = "";

  availableRounds.forEach(r => {
    const o = document.createElement("option");
    o.value = String(r);
    o.textContent = r + ". fordul√≥";
    roundSelect.appendChild(o);
  });

  selectedRound = availableRounds[0] ?? null;
  if (selectedRound !== null) roundSelect.value = String(selectedRound);

  const ids = allSeasonMatches.map(m => m.id);

  if (!ids.length) {
    matchesList.innerHTML = `<div class="muted">Ebben a szezonban m√©g nincs meccs.</div>`;
    return;
  }

  const { data: mp, error: mpErr } = await supabaseClient
    .from("match_players")
    .select("match_id,team,tabella(name)")
    .in("match_id", ids);

  if (mpErr) { console.error(mpErr); return; }

  allSeasonMP = mp || [];
  renderRound();
}

function renderRound() {
  matchesList.innerHTML = "";

  if (selectedRound === null) return;

  const ms = allSeasonMatches.filter(m => m.round == selectedRound);

  ms.forEach(m => {
    const b = allSeasonMP
      .filter(x => x.match_id == m.id && x.team == "black")
      .map(x => x.tabella?.name)
      .filter(Boolean)
      .join(", ");

    const w = allSeasonMP
      .filter(x => x.match_id == m.id && x.team == "white")
      .map(x => x.tabella?.name)
      .filter(Boolean)
      .join(", ");

    const div = document.createElement("div");
    div.className = "match";
    div.innerHTML = `
      <div class="match-top">
        <div class="score">‚ö´ ${m.black_score} ‚Äì ${m.white_score} ‚ö™</div>
      </div>
      <div class="teams"><span>‚ö´</span> ${b || "‚Äî"}</div>
      <div class="teams"><span>‚ö™</span> ${w || "‚Äî"}</div>
    `;
    matchesList.appendChild(div);
  });

  const idx = availableRounds.indexOf(Number(selectedRound));
  prevRoundBtn.disabled = idx === availableRounds.length - 1;
  nextRoundBtn.disabled = idx === 0;
}

/* ==== EVENTS ==== */
roundSelect.onchange = () => {
  selectedRound = Number(roundSelect.value);
  renderRound();
};

prevRoundBtn.onclick = () => {
  const idx = availableRounds.indexOf(Number(selectedRound));
  if (idx < availableRounds.length - 1) {
    selectedRound = availableRounds[idx + 1];
    roundSelect.value = String(selectedRound);
    renderRound();
  }
};

nextRoundBtn.onclick = () => {
  const idx = availableRounds.indexOf(Number(selectedRound));
  if (idx > 0) {
    selectedRound = availableRounds[idx - 1];
    roundSelect.value = String(selectedRound);
    renderRound();
  }
};

seasonSelect.onchange = async () => {
  selectedSeasonId = seasonSelect.value;
  const s = seasons.find(x => x.id === selectedSeasonId);
  selectedSeasonYear = s ? s.year : null;

  await loadTable();
  await loadMatches();
  if (selectedPlayerId) await loadPlayerCard(selectedPlayerId);

  startRealtime(); // ‚úÖ szezonv√°lt√°skor √∫jra feliratkozunk
};

/* ==== INIT ==== */
(async () => {
  await loadSeasons();
  await loadTable();
  await loadMatches();
  await loadAnnouncementPublic(); // ‚úÖ els≈ë bet√∂lt√©s
  startRealtime(); // ‚úÖ realtime indul
})();
</script>

</body>
</html>


