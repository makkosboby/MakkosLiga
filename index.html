<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Makkos Liga</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
<div class="container">

  <div class="top">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="assets/logo2.png" alt="Makkos Liga logo" style="height:42px; object-fit:contain;">
      <h1>Makkos Liga</h1>
    </div>

    <div class="controls">
      <label>Szezon</label>
      <select id="seasonSelect"></select>
      <span id="status" class="pill">‚Äî</span>
    </div>
  </div>

  <div class="layout">

    <!-- TABLA -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Tabella</div>
        <span id="tableMeta" class="pill">‚Äî</span>
      </div>
      <div class="card-body table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th><th style="text-align:left">N√©v</th>
              <th>M</th><th>Gy</th><th>D</th><th>V</th>
              <th>LG</th><th>KG</th><th>GK</th><th>P</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT -->
    <div>

      <div class="card" id="playerCard">
        <div class="card-header">
          <div class="card-title">J√°t√©kos</div>
          <span class="pill">√ñsszes√≠tett</span>
        </div>
        <div class="card-body">
          <div class="muted">Kattints egy n√©vre a tabell√°ban.</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="card-header">
          <div class="card-title">Meccsek</div>
          <span id="matchesMeta" class="pill">‚Äî</span>
        </div>
        <div class="card-body">
          <div class="roundbar">
            <label>Fordul√≥</label>
            <select id="roundSelect"></select>
            <button class="btn" id="prevRoundBtn" type="button">‚óÄ</button>
            <button class="btn" id="nextRoundBtn" type="button">‚ñ∂</button>
            <span id="matchesStatus" class="pill">‚Äî</span>
          </div>
          <div id="matchesList" style="margin-top:10px;"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ==== SUPABASE CLIENT ==== */
const supabaseUrl = "https://kqtzyhmksnjowielrwii.supabase.co";
const supabaseKey = "sb_publishable_vgSmqItheOG3aeOdoNionA_rd-4MTL2";
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ==== DOM ==== */
const seasonSelect = document.getElementById("seasonSelect");
const statusEl = document.getElementById("status");
const tableMeta = document.getElementById("tableMeta");
const tbody = document.getElementById("tbody");
const playerCard = document.getElementById("playerCard");

const roundSelect = document.getElementById("roundSelect");
const prevRoundBtn = document.getElementById("prevRoundBtn");
const nextRoundBtn = document.getElementById("nextRoundBtn");
const matchesStatus = document.getElementById("matchesStatus");
const matchesMeta = document.getElementById("matchesMeta");
const matchesList = document.getElementById("matchesList");

/* ==== STATE ==== */
let seasons = [];
let selectedSeasonId = null;
let selectedSeasonYear = null;

let selectedPlayerId = null;

let allSeasonMatches = [];
let allSeasonMP = [];
let availableRounds = [];
let selectedRound = null;

/* ==== LOADERS ==== */
async function loadSeasons() {
  const { data, error } = await supabaseClient
    .from("seasons")
    .select("id,year,is_current")
    .order("year", { ascending: false });

  if (error) {
    console.error(error);
    statusEl.textContent = "‚ùå hiba";
    return;
  }

  seasons = data || [];
  seasonSelect.innerHTML = "";

  seasons.forEach(s => {
    const o = document.createElement("option");
    o.value = s.id;
    o.textContent = s.year + (s.is_current ? " (aktu√°lis)" : "");
    seasonSelect.appendChild(o);
  });

  const cur = seasons.find(s => s.is_current) || seasons[0];

  if (cur) {
    selectedSeasonId = cur.id;
    selectedSeasonYear = cur.year;
    seasonSelect.value = cur.id;
    statusEl.textContent = String(cur.year);
  } else {
    statusEl.textContent = "‚Äî";
  }
}

async function loadTable() {
  const { data, error } = await supabaseClient
    .from("season_stats")
    .select("player_id,matches,wins,draws,losses,goals_for,goals_against,goal_diff,points,tabella(name)")
    .eq("season_id", selectedSeasonId)
    .order("points", { ascending: false })
    .order("goal_diff", { ascending: false });

  if (error) {
    console.error(error);
    tableMeta.textContent = "‚ùå hiba";
    return;
  }

  tbody.innerHTML = "";

  (data || []).forEach((r, i) => {
    const rankClass =
      i === 0 ? "top1" :
      i === 1 ? "top2" :
      i === 2 ? "top3" :
      "";

    const rankLabel =
      i === 0 ? "ü•á" :
      i === 1 ? "ü•à" :
      i === 2 ? "ü•â" :
      i + 1;

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td data-label=""><span class="rank ${rankClass}">${rankLabel}</span></td>
      <td class="name" data-label="N√©v">
        <button class="link" data-id="${r.player_id}">${r.tabella?.name ?? ""}</button>
      </td>
      <td data-label="M">${r.matches}</td>
      <td data-label="Gy">${r.wins}</td>
      <td data-label="D">${r.draws}</td>
      <td data-label="V">${r.losses}</td>
      <td data-label="LG">${r.goals_for}</td>
      <td data-label="KG">${r.goals_against}</td>
      <td data-label="GK">${r.goal_diff}</td>
      <td data-label="P"><b>${r.points}</b></td>
    `;

    tbody.appendChild(tr);
  });

  tableMeta.textContent = (data?.length || 0) + " j√°t√©kos";

  tbody.querySelectorAll("button").forEach(b => {
    b.onclick = () => loadPlayerCard(b.dataset.id);
  });
}

async function loadPlayerCard(playerId) {
  selectedPlayerId = playerId;

  const body = playerCard.querySelector(".card-body");
  body.innerHTML = `<div class="muted">Bet√∂lt√©s‚Ä¶</div>`;

  // 1) √ñsszes√≠tett stat (view)
  const { data: stats, error: statsErr } = await supabaseClient
    .from("player_overall_stats")
    .select(`
      player_id,
      name,
      matches_total,
      black_count,
      white_count,
      goals_for_total,
      goals_against_total,
      wins_total,
      draws_total,
      losses_total
    `)
    .eq("player_id", playerId)
    .single();

  if (statsErr) {
    console.error(statsErr);
    body.innerHTML = `<div class="error">‚ùå ${statsErr.message}</div>`;
    return;
  }

  // 2) Forma (utols√≥ 5 meccs) ‚Äì match_players + matches join
  const { data: lastRows, error: formErr } = await supabaseClient
    .from("match_players")
    .select(`
      team,
      matches ( black_score, white_score, created_at )
    `)
    .eq("player_id", playerId)
    .order("created_at", { foreignTable: "matches", ascending: false })
    .limit(5);

  if (formErr) console.error(formErr);

  const form = (lastRows || [])
    .filter(r => r.matches)
    .map(r => {
      const b = r.matches.black_score;
      const w = r.matches.white_score;

      if (b === w) return { code: "D", cls: "draw", title: "D√∂ntetlen" };

      const isWin =
        (r.team === "black" && b > w) ||
        (r.team === "white" && w > b);

      return isWin
        ? { code: "W", cls: "win", title: "Gy≈ëzelem" }
        : { code: "L", cls: "loss", title: "Veres√©g" };
    });

  const formHtml = form.length
    ? `<div class="form">${form.map(x => `<span class="form-badge ${x.cls}" title="${x.title}">${x.code}</span>`).join("")}</div>`
    : `<div class="form-empty">M√©g nincs el√©g meccs a form√°hoz.</div>`;

  // 3) Render
  body.innerHTML = `
    <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <div style="font-size:16px; font-weight:800; letter-spacing:.2px;">${stats.name}</div>
      <div class="pill">minden szezon</div>
    </div>

    <div class="kv">
      <div>Meccsek</div><div><b>${stats.matches_total}</b></div>
      <div>‚ö´ Fekete</div><div><b>${stats.black_count}</b></div>
      <div>‚ö™ Feh√©r</div><div><b>${stats.white_count}</b></div>

      <div>L≈ëtt g√≥l</div><div><b>${stats.goals_for_total}</b></div>
      <div>Kapott g√≥l</div><div><b>${stats.goals_against_total}</b></div>

      <div>Gy≈ëzelem</div><div><b>${stats.wins_total}</b></div>
      <div>D√∂ntetlen</div><div><b>${stats.draws_total}</b></div>
      <div>Veres√©g</div><div><b>${stats.losses_total}</b></div>
    </div>

    <div class="form-row">
      <div class="form-title">
        <b>Forma</b>
        <span class="muted">utols√≥ 5 meccs</span>
      </div>
      ${formHtml}
    </div>
  `;
}

async function loadMatches() {
  const { data: matches, error: mErr } = await supabaseClient
    .from("matches")
    .select("id,round,black_score,white_score,created_at")
    .eq("season_id", selectedSeasonId)
    .order("round", { ascending: false });

  if (mErr) {
    console.error(mErr);
    matchesStatus.textContent = "‚ùå";
    return;
  }

  allSeasonMatches = matches || [];
  matchesMeta.textContent = allSeasonMatches.length + " √∂sszesen";

  // rounds
  availableRounds = [...new Set(allSeasonMatches.map(m => m.round))].sort((a,b)=>b-a);
  roundSelect.innerHTML = "";

  availableRounds.forEach(r => {
    const o = document.createElement("option");
    o.value = String(r);
    o.textContent = r + ". fordul√≥";
    roundSelect.appendChild(o);
  });

  selectedRound = availableRounds[0] ?? null;
  if (selectedRound !== null) roundSelect.value = String(selectedRound);

  const ids = allSeasonMatches.map(m => m.id);

  if (!ids.length) {
    matchesStatus.textContent = "0";
    matchesList.innerHTML = `<div class="muted">Ebben a szezonban m√©g nincs meccs.</div>`;
    return;
  }

  const { data: mp, error: mpErr } = await supabaseClient
    .from("match_players")
    .select("match_id,team,tabella(name)")
    .in("match_id", ids);

  if (mpErr) {
    console.error(mpErr);
    matchesStatus.textContent = "‚ùå";
    return;
  }

  allSeasonMP = mp || [];
  renderRound();
}

function renderRound() {
  matchesList.innerHTML = "";

  if (selectedRound === null) {
    matchesStatus.textContent = "0";
    return;
  }

  const ms = allSeasonMatches.filter(m => m.round == selectedRound);

  // mutassuk mennyi meccs van a fordul√≥ban
  matchesStatus.textContent = String(ms.length);

  ms.forEach(m => {
    const b = allSeasonMP
      .filter(x => x.match_id == m.id && x.team == "black")
      .map(x => x.tabella?.name)
      .filter(Boolean)
      .join(", ");

    const w = allSeasonMP
      .filter(x => x.match_id == m.id && x.team == "white")
      .map(x => x.tabella?.name)
      .filter(Boolean)
      .join(", ");

    const div = document.createElement("div");
    div.className = "match";
    div.innerHTML = `
      <div class="match-top">
        <div class="score">‚ö´ ${m.black_score} ‚Äì ${m.white_score} ‚ö™</div>
      </div>
      <div class="teams"><span>‚ö´</span> ${b || "‚Äî"}</div>
      <div class="teams"><span>‚ö™</span> ${w || "‚Äî"}</div>
    `;
    matchesList.appendChild(div);
  });

  // prev/next disable
  const idx = availableRounds.indexOf(Number(selectedRound));
  prevRoundBtn.disabled = idx === availableRounds.length - 1;
  nextRoundBtn.disabled = idx === 0;
}

/* ==== EVENTS ==== */
roundSelect.onchange = () => {
  selectedRound = Number(roundSelect.value);
  renderRound();
};

prevRoundBtn.onclick = () => {
  const idx = availableRounds.indexOf(Number(selectedRound));
  if (idx < availableRounds.length - 1) {
    selectedRound = availableRounds[idx + 1];
    roundSelect.value = String(selectedRound);
    renderRound();
  }
};

nextRoundBtn.onclick = () => {
  const idx = availableRounds.indexOf(Number(selectedRound));
  if (idx > 0) {
    selectedRound = availableRounds[idx - 1];
    roundSelect.value = String(selectedRound);
    renderRound();
  }
};

seasonSelect.onchange = async () => {
  selectedSeasonId = seasonSelect.value;
  const s = seasons.find(x => x.id === selectedSeasonId);
  selectedSeasonYear = s ? s.year : null;
  statusEl.textContent = selectedSeasonYear ? String(selectedSeasonYear) : "‚Äî";

  await loadTable();
  await loadMatches();
  if (selectedPlayerId) await loadPlayerCard(selectedPlayerId);
};

/* ==== INIT ==== */
(async () => {
  await loadSeasons();
  await loadTable();
  await loadMatches();
})();
</script>

</body>
</html>
